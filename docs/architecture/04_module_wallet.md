# ğŸ’° é’±åŒ…æ¨¡å—è®¾è®¡æ–‡æ¡£ï¼ˆWallet Moduleï¼‰ - CRM Lite

## ğŸ“Œ æ¨¡å—æ¦‚è¿°

é’±åŒ…æ¨¡å—ç”¨äºä¸ºå®¢æˆ·è´¦æˆ·æä¾›ä½™é¢è®°å½•ã€å……å€¼ã€æ¶ˆè´¹ã€é€€æ¬¾ç­‰åŸºæœ¬äº¤æ˜“èƒ½åŠ›ã€‚é€‚ç”¨äºä¼šå‘˜å¡ä½™é¢ã€ç§¯åˆ†è´¦æˆ·ã€æŠ¼é‡‘è´¦æˆ·ç­‰å¤šç§èµ„é‡‘æ¨¡å¼çš„å®ç°ã€‚

---

## ğŸ§± æ•°æ®æ¨¡å‹è®¾è®¡

### é’±åŒ…ä¸»è¡¨ï¼ˆwalletï¼‰

| å­—æ®µå        | ç±»å‹     | æè¿°                    |
|---------------|----------|-------------------------|
| `id`          | UUID     | é’±åŒ…å”¯ä¸€æ ‡è¯†            |
| `customer_id` | UUID     | æ‰€å±å®¢æˆ·ID              |
| `balance`     | float    | å½“å‰ä½™é¢ (æ³¨æ„ï¼šä½¿ç”¨ float ç±»å‹å¤„ç†é‡‘é¢éœ€æ³¨æ„ç²¾åº¦é—®é¢˜ï¼Œæˆ–è€ƒè™‘ä½¿ç”¨å®šç‚¹æ•°/æ•´æ•°å­˜å‚¨åˆ†)                |
| `type`        | string   | é’±åŒ…ç±»å‹ï¼ˆå¦‚ `balance`ç°é‡‘ä½™é¢, `points`ç§¯åˆ†ï¼‰|
| `created_at`  | datetime | åˆ›å»ºæ—¶é—´                |
| `updated_at`  | datetime | æ›´æ–°æ—¶é—´                |

### é’±åŒ…æµæ°´è¡¨ï¼ˆwallet_transactionï¼‰

| å­—æ®µå          | ç±»å‹     | æè¿°                      |
|------------------|----------|---------------------------|
| `id`             | UUID     | äº¤æ˜“å”¯ä¸€æ ‡è¯†              |
| `wallet_id`      | UUID     | æ‰€å±é’±åŒ…ID (`wallet.id`)   |
| `type`           | string   | äº¤æ˜“ç±»å‹ï¼ˆ`recharge`å……å€¼ / `consume`æ¶ˆè´¹ / `refund`é€€æ¬¾ / `correction`è°ƒæ•´ï¼‰|
| `amount`         | float    | é‡‘é¢ï¼ˆæ­£æ•°è¡¨ç¤ºå¢åŠ , è´Ÿæ•°è¡¨ç¤ºå‡å°‘ï¼‰(æ³¨æ„ï¼šä½¿ç”¨ float ç±»å‹å¤„ç†é‡‘é¢éœ€æ³¨æ„ç²¾åº¦é—®é¢˜ï¼Œæˆ–è€ƒè™‘ä½¿ç”¨å®šç‚¹æ•°/æ•´æ•°å­˜å‚¨åˆ†)         |
| `source`         | string   | äº¤æ˜“æ¥æºï¼ˆå¦‚ `order:uuid`, `manual`, `system_init`ï¼‰  |
| `related_id`     | string   | å…³è”ID (ä¾‹å¦‚è®¢å•ID, æ´»åŠ¨IDç­‰ï¼Œå¯é€‰) |
| `remark`         | string   | å¤‡æ³¨                      |
| `created_at`     | datetime | åˆ›å»ºæ—¶é—´                  |

---

## ğŸ”Œ æ¥å£è®¾è®¡ï¼ˆRESTfulï¼‰

### é’±åŒ…æ¥å£

#### GET `/api/v1/customers/:id/wallet`

- æè¿°ï¼šè·å–æŒ‡å®šå®¢æˆ·çš„å…¨éƒ¨é’±åŒ…è´¦æˆ·ä¿¡æ¯ï¼ˆä¸€ä¸ªå®¢æˆ·å¯èƒ½æ‹¥æœ‰å¤šç§ç±»å‹çš„é’±åŒ…ï¼Œå¦‚ç°é‡‘é’±åŒ…ã€ç§¯åˆ†é’±åŒ…ï¼‰ã€‚
- è¯·æ±‚å‚æ•°ï¼šæ— 
- è¿”å›ï¼š

```json
{
  "wallets": [
    {
      "id": "wallet-uuid-balance",
      "customer_id": "customer-uuid",
      "type": "balance",
      "balance": 150.75,
      "updated_at": "2024-01-01T10:00:00Z"
    },
    {
      "id": "wallet-uuid-points",
      "customer_id": "customer-uuid",
      "type": "points",
      "balance": 2000,
      "updated_at": "2024-01-01T11:00:00Z"
    }
  ]
}
```

#### POST `/api/v1/customers/:id/wallet/transactions`  ï¼ˆå……å€¼ã€æ¶ˆè´¹ç­‰ç»Ÿä¸€ä½¿ç”¨è¯¥æ¥å£ï¼‰

- æè¿°ï¼šä¸ºå®¢æˆ·æŒ‡å®šç±»å‹çš„é’±åŒ…å……å€¼ã€‚
- è¯·æ±‚ä½“ (JSON)ï¼š

```json
{
  "wallet_type": "balance", // æˆ– "points"
  "amount": 100.00,
  "source": "manual_recharge", // æˆ– "payment_gateway_xyz"
  "remark": "çº¿ä¸‹å……å€¼100å…ƒç°é‡‘"
}
```

- è¿”å›ï¼šæˆåŠŸæ—¶è¿”å›æ–°çš„äº¤æ˜“æµæ°´è®°å½•å’Œæ›´æ–°åçš„é’±åŒ…ä¿¡æ¯ã€‚

```json
{
  "transaction": {
    "id": "trans-uuid",
    "wallet_id": "wallet-uuid-balance",
    "type": "recharge",
    "amount": 100.00,
    "source": "manual_recharge",
    "remark": "çº¿ä¸‹å……å€¼100å…ƒç°é‡‘",
    "created_at": "2024-01-02T14:30:00Z"
  },
  "wallet": {
      "id": "wallet-uuid-balance",
      "type": "balance",
      "balance": 250.75,
      "updated_at": "2024-01-02T14:30:00Z"
  }
}
```

ä¸å†åŒºåˆ† `recharge`ã€`consume` å•ç‹¬ç«¯ç‚¹ï¼Œå…¨éƒ¨é€šè¿‡ä¸Šè¿° `POST /transactions` æ¥å£å¹¶åœ¨è¯·æ±‚ä½“ä¸­æŒ‡å®š `type` å­—æ®µ (`recharge`, `consume`, `refund`, `correction`)ã€‚

#### GET `/api/v1/customers/:id/wallet/transactions`

- æè¿°ï¼šè·å–æŸå®¢æˆ·ç‰¹å®šç±»å‹é’±åŒ…çš„äº¤æ˜“æµæ°´ï¼Œæˆ–æ‰€æœ‰ç±»å‹é’±åŒ…çš„äº¤æ˜“æµæ°´ï¼ˆå¦‚æœ `wallet_type` æœªæŒ‡å®šï¼‰ã€‚
- è¯·æ±‚å‚æ•°ï¼š
  - `wallet_type` (string, å¯é€‰)ï¼šé’±åŒ…ç±»å‹ï¼ˆå¦‚ `balance`, `points`ï¼‰è¿›è¡Œç­›é€‰ã€‚
  - `transaction_type` (string, å¯é€‰): äº¤æ˜“ç±»å‹ (`recharge`, `consume`, `refund`) ç­›é€‰ã€‚
  - `start_date` (date, å¯é€‰)ï¼šèµ·å§‹æ—¥æœŸã€‚
  - `end_date` (date, å¯é€‰)ï¼šç»“æŸæ—¥æœŸã€‚
  - `page` (int, å¯é€‰)ï¼šé¡µç ã€‚
  - `page_size` (int, å¯é€‰)ï¼šæ¯é¡µæ•°é‡ã€‚
- è¿”å›ï¼š

```json
{
  "transactions": [
    {
      "id": "trans-uuid-1",
      "wallet_id": "wallet-uuid-balance",
      "type": "recharge",
      "amount": 100.00,
      "source": "manual_recharge",
      "remark": "é¦–æ¬¡å……å€¼",
      "created_at": "2024-01-01T10:00:00Z"
    },
    {
      "id": "trans-uuid-2",
      "wallet_id": "wallet-uuid-balance",
      "type": "consume",
      "amount": -20.50,
      "source": "order:order-uuid-abc",
      "remark": "è´­ä¹°å•†å“A",
      "created_at": "2024-01-01T12:00:00Z"
    }
  ],
  "pagination": {
    "total": 20,
    "page": 1,
    "page_size": 10
  }
}
```

---

### ğŸ” æƒé™ä¸æ ¡éªŒ

- æ‰€æœ‰èµ„é‡‘æ“ä½œï¼ˆå……å€¼ã€æ¶ˆè´¹ç­‰ï¼‰å‡éœ€ç”¨æˆ·å…·å¤‡å¦‚ `wallet:recharge`, `wallet:consume` ç­‰ç²¾ç»†åŒ–æƒé™ï¼Œæˆ–ç»Ÿä¸€çš„ `wallet:write` æƒé™ã€‚
- æ¶ˆè´¹é‡‘é¢ä¸å¯è¶…å‡ºå½“å‰é’±åŒ…ç±»å‹çš„å¯ç”¨ä½™é¢ã€‚
- æ‰€æœ‰äº¤æ˜“æ“ä½œå‡è®°å½•åœ¨ `wallet_transaction` è¡¨ä¸­ï¼Œä½œä¸ºèµ„é‡‘æµè½¬çš„å®¡è®¡æ—¥å¿—ã€‚
- å…³é”®æ“ä½œï¼ˆå¦‚ä¿®æ”¹ä½™é¢ï¼‰åº”è€ƒè™‘å¹¶å‘æ§åˆ¶ï¼Œä¾‹å¦‚ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡å’Œä¹è§‚é”/æ‚²è§‚é”ã€‚

---

### ğŸ§ª å•å…ƒæµ‹è¯•å»ºè®®

- å……å€¼ã€æ¶ˆè´¹ã€é€€æ¬¾ç­‰æ“ä½œçš„è¾¹ç•Œå€¼æµ‹è¯•ï¼ˆä¾‹å¦‚ï¼Œ0é‡‘é¢ï¼Œè¶…é¢æ¶ˆè´¹ï¼‰ã€‚
- ä¸åŒé’±åŒ…ç±»å‹æ“ä½œçš„éš”ç¦»æ€§ä¸æ­£ç¡®æ€§ã€‚
- è´Ÿæ•°äº¤æ˜“é€»è¾‘ï¼ˆå¦‚æ¶ˆè´¹ã€é€€æ¬¾éƒ¨åˆ†å†²æ­£ï¼‰å’Œå¼‚å¸¸å¤„ç†ã€‚
- æ¨¡æ‹Ÿå¹¶å‘æ¶ˆè´¹æˆ–å……å€¼ï¼ŒéªŒè¯æ•°æ®ä¸€è‡´æ€§å’Œäº‹åŠ¡çš„æ­£ç¡®æ€§ã€‚
- äº¤æ˜“æµæ°´æŸ¥è¯¢çš„å‡†ç¡®æ€§ï¼ˆåŸºäºç±»å‹ã€æ—¥æœŸç­‰ï¼‰ã€‚

---

### ğŸ’¡ æ‰©å±•å»ºè®®

- æ”¯æŒå¤šç§é’±åŒ…ç±»å‹ï¼Œå¦‚ç°é‡‘ä½™é¢ (`balance`)ã€ç§¯åˆ† (`points`)ã€ä¼˜æƒ åˆ¸ä½™é¢ (`coupon_balance`)ã€æŠ¼é‡‘ (`deposit`) ç­‰ã€‚
- ä¸ºç‰¹å®šé’±åŒ…ç±»å‹ï¼ˆå¦‚ç§¯åˆ†ï¼‰å¢åŠ è‡ªåŠ¨è¿‡æœŸæœºåˆ¶å’Œæé†’ã€‚
- å¯¹æ¥ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°ï¼ˆå¦‚æ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜ï¼‰å®ç°ç”¨æˆ·è‡ªåŠ©åœ¨çº¿å……å€¼ã€‚
- å¢åŠ é’±åŒ…å†»ç»“/è§£å†»åŠŸèƒ½ï¼Œç”¨äºå¤„ç†äº‰è®®äº¤æ˜“æˆ–é£é™©æ§åˆ¶ã€‚
- è€ƒè™‘èµ„é‡‘å¯†ç æˆ–äºŒæ¬¡éªŒè¯ï¼Œå¢å¼ºé«˜é£é™©æ“ä½œçš„å®‰å…¨æ€§ã€‚
