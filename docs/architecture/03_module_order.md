# ðŸ›’ è®¢å•æ¨¡å—è®¾è®¡æ–‡æ¡£ (Order Module) - CRM Lite

## ðŸ“Œ æ¨¡å—æ¦‚è¿°

è®¢å•æ¨¡å—æ˜¯ CRM ç³»ç»Ÿçš„ä¸šåŠ¡æ ¸å¿ƒï¼Œç”¨äºŽè®°å½•å®¢æˆ·çš„è´­ä¹°è¡Œä¸ºã€‚å®ƒä¸Žå®¢æˆ·æ¨¡å—å’Œäº§å“æ¨¡å—ç´§å¯†ç›¸è¿žï¼Œè´Ÿè´£åˆ›å»ºã€æŸ¥è¯¢å’Œç®¡ç†è®¢å•åŠå…¶åŒ…å«çš„è®¢å•é¡¹ã€‚

---

## ðŸ§± æ•°æ®æ¨¡åž‹è®¾è®¡

### è®¢å•ä¸»è¡¨ (`orders`)

| å­—æ®µå        | ç±»åž‹          | è¯´æ˜Ž                             |
|---------------|---------------|----------------------------------|
| `id`          | bigint        | è®¢å•å”¯ä¸€æ ‡è¯† (è‡ªå¢žä¸»é”®)         |
| `order_no`    | varchar(100)  | å”¯ä¸€è®¢å•å· (ä¸šåŠ¡ID)            |
| `customer_id` | bigint        | å…³è”çš„å®¢æˆ· ID                   |
| `order_date`  | datetime      | ä¸‹å•æ—¥æœŸ                         |
| `status`      | varchar(50)   | è®¢å•çŠ¶æ€ (e.g., draft, pending, confirmed) |
| `total_amount`| decimal(10,2) | è®¢å•æ€»é‡‘é¢ (å„è®¢å•é¡¹æœ€ç»ˆä»·æ ¼ä¹‹å’Œ) |
| `final_amount`| decimal(10,2) | æœ€ç»ˆæ”¯ä»˜é‡‘é¢ (å¯åŒ…å«æŠ˜æ‰£ã€è¿è´¹ç­‰) |
| `remark`      | text          | è®¢å•å¤‡æ³¨                         |
| `created_at`  | datetime      | åˆ›å»ºæ—¶é—´                         |
| `updated_at`  | datetime      | æ›´æ–°æ—¶é—´                         |
| `deleted_at`  | datetime      | è½¯åˆ é™¤å­—æ®µ                       |

### è®¢å•é¡¹è¡¨ (`order_items`)

| å­—æ®µå         | ç±»åž‹         | è¯´æ˜Ž                         |
|----------------|--------------|------------------------------|
| `id`           | bigint       | è®¢å•é¡¹å”¯ä¸€æ ‡è¯† (è‡ªå¢žä¸»é”®)   |
| `order_id`     | bigint       | å…³è”çš„è®¢å• ID                |
| `product_id`   | bigint       | å…³è”çš„äº§å“ ID                |
| `product_name` | varchar(255) | äº§å“åç§°å¿«ç…§                 |
| `quantity`     | int          | è´­ä¹°æ•°é‡                     |
| `unit_price`   | decimal(10,2)| æˆäº¤å•ä»· (å¿«ç…§)              |
| `final_price`  | decimal(10,2)| æœ€ç»ˆä»·æ ¼ (quantity * unit_price) |

**è®¾è®¡è€ƒé‡**:

* `order_items` ä¸­çš„ `product_name` å’Œ `unit_price` æ˜¯**æ•°æ®å¿«ç…§**ï¼Œç¡®ä¿å³ä½¿æœªæ¥äº§å“ä¿¡æ¯å˜æ›´ï¼ŒåŽ†å²è®¢å•çš„è®°å½•ä¹Ÿä¸ä¼šæ”¹å˜ã€‚
* è®¢å•çš„åˆ›å»ºæ˜¯**äº‹åŠ¡æ€§**çš„ï¼Œ`orders` å’Œ `order_items` çš„å†™å…¥å¿…é¡»åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ã€‚

---

## ðŸ“‚ æ¨¡å—ç›®å½•ç»“æž„

```text
internal/
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ order_controller.go    # å¤„ç†è®¢å•ç›¸å…³çš„ HTTP è¯·æ±‚
â”œâ”€â”€ service/
â”‚   â””â”€â”€ order_service.go       # å°è£…è®¢å•ä¸šåŠ¡é€»è¾‘ï¼ŒåŒ…å«äº‹åŠ¡å¤„ç†
â”œâ”€â”€ dto/
â”‚   â””â”€â”€ order.go               # è®¢å•æ¨¡å—çš„æ•°æ®ä¼ è¾“å¯¹è±¡ (DTO)
â””â”€â”€ routes/
    â””â”€â”€ order.go               # æ³¨å†Œè®¢å•æ¨¡å—çš„ API è·¯ç”±
```

*GORM Gen ç”Ÿæˆçš„ `dao` å±‚æ–‡ä»¶æœªåœ¨æ­¤åˆ—å‡ºã€‚*

---

## ðŸ”Œ æŽ¥å£è®¾è®¡ (RESTful API)

### `POST /orders`

* **æè¿°**: åˆ›å»ºä¸€ä¸ªæ–°è®¢å•ã€‚æ­¤æ“ä½œæ˜¯äº‹åŠ¡æ€§çš„ã€‚
* **è¯·æ±‚ä½“** (`dto.OrderCreateRequest`):

    ```json
    {
      "customer_id": 1,
      "order_date": "2024-07-15T10:00:00Z",
      "status": "pending",
      "remark": "è¯·å°½å¿«å‘è´§",
      "items": [
        {
          "product_id": 101,
          "quantity": 2,
          "unit_price": 499.50
        },
        {
          "product_id": 102,
          "quantity": 1,
          "unit_price": 899.00
        }
      ]
    }
    ```

* **æˆåŠŸå“åº”** (200 OK): è¿”å›žæ–°åˆ›å»ºçš„è®¢å•å®Œæ•´ä¿¡æ¯ï¼ŒåŒ…æ‹¬å…¶è®¢å•é¡¹ (`dto.OrderResponse`)ã€‚
* **é”™è¯¯å“åº”**:
  * `400 Bad Request`: å®¢æˆ·ä¸å­˜åœ¨æˆ–æŸä¸ªäº§å“ä¸å­˜åœ¨ã€‚
  * `500 Internal Server Error`: æ•°æ®åº“äº‹åŠ¡å¤±è´¥ã€‚

### `GET /orders/:id`

* **æè¿°**: æ ¹æ® ID èŽ·å–å•ä¸ªè®¢å•çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¼šé¢„åŠ è½½ (Preload) å…³è”çš„è®¢å•é¡¹ã€‚
* **æˆåŠŸå“åº”** (200 OK): è¿”å›žè®¢å•åŠå…¶è®¢å•é¡¹çš„å®Œæ•´ä¿¡æ¯ (`dto.OrderResponse`)ã€‚
* **é”™è¯¯å“åº”**:
  * `404 Not Found`: è®¢å•ä¸å­˜åœ¨ã€‚

### `GET /orders`

* **æè¿°**: èŽ·å–è®¢å•åˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µã€ç­›é€‰å’ŒæŽ’åºï¼ŒåŒæ ·ä¼šé¢„åŠ è½½è®¢å•é¡¹ã€‚
* **æŸ¥è¯¢å‚æ•°** (`dto.OrderListRequest`):
  * `page`, `page_size` (å¯é€‰): åˆ†é¡µå‚æ•°ã€‚
  * `customer_id` (å¯é€‰): æŒ‰å®¢æˆ· ID ç­›é€‰ã€‚
  * `status` (å¯é€‰): æŒ‰è®¢å•çŠ¶æ€ç­›é€‰ã€‚
  * `order_by` (å¯é€‰): æŽ’åºï¼Œä¾‹å¦‚ `order_date_desc`ã€‚
  * `ids` (å¯é€‰): æŒ‰è®¢å•IDåˆ—è¡¨æ‰¹é‡æŸ¥è¯¢ã€‚
* **æˆåŠŸå“åº”** (200 OK): è¿”å›žè®¢å•åˆ—è¡¨å’Œæ€»æ•° (`dto.OrderListResponse`)ã€‚

---

### ðŸ” æƒé™è®¾è®¡å»ºè®®

* **é”€å”® (`sales`)**: å¯ä»¥ä¸ºè‡ªå·±åä¸‹çš„å®¢æˆ·åˆ›å»ºè®¢å•ï¼ŒæŸ¥çœ‹è‡ªå·±åˆ›å»ºçš„è®¢å•ã€‚
* **è®¢å•ç®¡ç†å‘˜ (`order_admin`)**: å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰è®¢å•ï¼Œä½†å¯èƒ½æ— æ³•ä¿®æ”¹å·²å®Œæˆæˆ–å·²å–æ¶ˆçš„è®¢å•ã€‚
* **å®¢æˆ·**: (å¦‚æžœæœªæ¥æœ‰å®¢æˆ·é—¨æˆ·) å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„åŽ†å²è®¢å•ã€‚

---

### ðŸ§ª æµ‹è¯•å»ºè®®

* **æ ¸å¿ƒé€»è¾‘**: é‡ç‚¹æµ‹è¯• `OrderService` çš„ `CreateOrder` æ–¹æ³•ï¼Œç¡®ä¿æ•°æ®åº“äº‹åŠ¡åœ¨å„ç§æƒ…å†µä¸‹ï¼ˆå¦‚å®¢æˆ·ä¸å­˜åœ¨ã€äº§å“ä¸å­˜åœ¨ã€åº“å­˜ä¸è¶³ç­‰ï¼‰éƒ½èƒ½æ­£ç¡®å›žæ»šã€‚
* **æ•°æ®ä¸€è‡´æ€§**: éªŒè¯åˆ›å»ºè®¢å•åŽï¼Œäº§å“å¿«ç…§ä¿¡æ¯ï¼ˆåç§°ã€å•ä»·ï¼‰æ˜¯å¦æ­£ç¡®å†™å…¥ `order_items` è¡¨ã€‚
* **æŸ¥è¯¢æ€§èƒ½**: éªŒè¯ `GetOrder` å’Œ `ListOrders` æ˜¯å¦èƒ½é€šè¿‡ `Preload` æœ‰æ•ˆé¿å… N+1 æŸ¥è¯¢é—®é¢˜ã€‚
* **è¾¹ç•Œæƒ…å†µ**: æµ‹è¯•åˆ›å»ºåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªè®¢å•é¡¹çš„è®¢å•ã€‚

---

### ðŸ“Ž ä¾èµ–è¯´æ˜Ž

* **GORM**: ç”¨äºŽäº‹åŠ¡å¤„ç†å’Œæ•°æ®é¢„åŠ è½½ã€‚
* **Gin**: Web æ¡†æž¶ã€‚
* **`pkg/utils/randx.go`**: ç”¨äºŽç”Ÿæˆå”¯ä¸€çš„è®¢å•å· `order_no`ã€‚

---

### ðŸ’¡ æ‰©å±•å»ºè®®

* **è®¢å•çŠ¶æ€æµè½¬**: å¼•å…¥çŠ¶æ€æœºæ¥ç®¡ç†è®¢å•çŠ¶æ€çš„å˜æ›´ï¼ˆä¾‹å¦‚ï¼Œ`pending` -> `
